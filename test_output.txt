[2025-12-31 16:18:10,995] WARNING in main: ⚠️ Column verification failed: (sqlite3.OperationalError) near "EXISTS": syntax error
[SQL: 
                        ALTER TABLE survey_submissions
                        ADD COLUMN IF NOT EXISTS name VARCHAR(256);
                        ]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
============================= test session starts ==============================
platform darwin -- Python 3.14.0, pytest-9.0.1, pluggy-1.6.0 -- /Users/mr/attuned-survey-1/backend/venv/bin/python3.14
cachedir: .pytest_cache
rootdir: /Users/mr/attuned-survey-1
plugins: anyio-4.11.0
collecting ... collected 1 item

backend/tests/test_subscriptions_auth.py::test_check_daily_limit_enforced [2025-12-31 16:18:11,263] WARNING in main: ⚠️ Column verification failed: (sqlite3.OperationalError) near "EXISTS": syntax error
[SQL: 
                        ALTER TABLE survey_submissions
                        ADD COLUMN IF NOT EXISTS name VARCHAR(256);
                        ]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
FAILED

=================================== FAILURES ===================================
_______________________ test_check_daily_limit_enforced ________________________

client = <FlaskClient <Flask 'backend.src.main'>>, app_context = None
mock_auth_user = <User test@example.com>
db_session = <sqlalchemy.orm.scoping.scoped_session object at 0x10c3ed310>

    def test_check_daily_limit_enforced(client, app_context, mock_auth_user, db_session):
        """Test daily limit enforcement for free tier"""
        mock_auth_user.subscription_tier = 'free'
        mock_auth_user.daily_activity_count = 25  # At limit
        db_session.add(mock_auth_user)
        db_session.commit()
    
        with patch('src.middleware.auth.jwt.decode') as mock_decode:
            mock_decode.return_value = {"sub": str(mock_auth_user.id)}
    
            response = client.get(
                f'/api/subscriptions/check-limit/{mock_auth_user.id}',
                headers={'Authorization': 'Bearer valid-token'}
            )
    
>           assert response.status_code == 200
E           assert 500 == 200
E            +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code

backend/tests/test_subscriptions_auth.py:102: AssertionError
------------------------------ Captured log setup ------------------------------
WARNING  backend.src.main:main.py:137 ⚠️ Column verification failed: (sqlite3.OperationalError) near "EXISTS": syntax error
[SQL: 
                        ALTER TABLE survey_submissions
                        ADD COLUMN IF NOT EXISTS name VARCHAR(256);
                        ]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
------------------------------ Captured log call -------------------------------
ERROR    backend.src.routes.subscriptions:subscriptions.py:106 Check limit failed: can't compare offset-naive and offset-aware datetimes
=============================== warnings summary ===============================
backend/tests/test_subscriptions_auth.py::test_check_daily_limit_enforced
  /Users/mr/attuned-survey-1/backend/tests/test_subscriptions_auth.py:27: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    daily_activity_reset_at=datetime.utcnow(),

backend/tests/test_subscriptions_auth.py::test_check_daily_limit_enforced
  /Users/mr/attuned-survey-1/backend/tests/test_subscriptions_auth.py:28: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    created_at=datetime.utcnow(),

backend/tests/test_subscriptions_auth.py::test_check_daily_limit_enforced
  /Users/mr/attuned-survey-1/backend/tests/test_subscriptions_auth.py:29: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    updated_at=datetime.utcnow(),

backend/tests/test_subscriptions_auth.py::test_check_daily_limit_enforced
  /Users/mr/attuned-survey-1/backend/tests/test_subscriptions_auth.py:30: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    last_login_at=datetime.utcnow(),

backend/tests/test_subscriptions_auth.py::test_check_daily_limit_enforced
  /Users/mr/attuned-survey-1/backend/venv/lib/python3.14/site-packages/sqlalchemy/sql/schema.py:3624: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return util.wrap_callable(lambda ctx: fn(), fn)  # type: ignore

backend/tests/test_subscriptions_auth.py::test_check_daily_limit_enforced
  /Users/mr/attuned-survey-1/backend/tests/conftest.py:79: SAWarning: nested transaction already deassociated from connection
    transaction.rollback()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED backend/tests/test_subscriptions_auth.py::test_check_daily_limit_enforced - assert 500 == 200
 +  where 500 = <WrapperTestResponse streamed [500 INTERNAL SERVER ERROR]>.status_code
======================== 1 failed, 6 warnings in 0.08s =========================
